# Implementation Plan: Three Kingdoms Dark Chess (‰∏âÂúãÊöóÊ£ã)

**Branch**: `002-three-kingdoms-dark-chess` | **Date**: 2026-01-22 | **Spec**: `specs/002-three-kingdoms-dark-chess/spec.md`  
**Input**: Feature specification from `/specs/002-three-kingdoms-dark-chess/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

---

## Summary

Implement the Three Kingdoms Dark Chess (‰∏âÂúãÊöóÊ£ã) variant, a 3-player game mode that extends the existing Classic Dark Chess foundation. This requires a significant architectural refactoring to support multiple game modes through a Strategy Pattern (RuleSet abstraction). The core logic will be implemented as pure TypeScript with zero UI dependencies, maintaining 100% unit test coverage. The Three Kingdoms variant features 45 intersection points (vs 32 cells), 3 factions (vs 2), no rank hierarchy, modified movement rules, a 60-move draw counter, and elimination-based victory conditions.

**Key Changes**:
- **Architecture**: Refactor GameEngine to use pluggable RuleSet interface (ClassicRules, ThreeKingdomsRules)
- **Data Model**: Replace `color: 'red' | 'black'` with `factionId` + Faction entity for N-player support
- **Board**: Dynamic-size Board array (32 for Classic, 45 for Three Kingdoms with 13 empty intersections)
- **UI**: Separate board renderers (ClassicBoardRenderer for cells, IntersectionBoardRenderer for grid points)
- **State**: Extend Zustand store with mode selection, draw counter, and 3-player turn rotation

---

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode enabled)  
**Primary Dependencies**: 
- React Native ^0.74.x
- Expo SDK (Managed Workflow)
- Zustand ^4.5.x (state management)
- Jest ^29.x (testing)
- AsyncStorage (mode persistence)

**Storage**: In-memory state + AsyncStorage for mode persistence  
**Testing**: Jest for unit tests (100% coverage required for core logic), React Native Testing Library for UI integration tests  
**Target Platform**: iOS and Android via Expo Managed Workflow  
**Project Type**: Mobile application  

**Performance Goals**: 
- Match initialization < 2 seconds
- Move validation < 10ms
- Board rendering 60 FPS
- UI responsiveness with 3 players (no lag)

**Constraints**: 
- Offline-capable (no network required)
- < 100MB memory footprint
- Responsive 5x9 grid layout for Three Kingdoms
- Backward compatible with Classic mode (no regressions)

**Scale/Scope**: 
- 2 game modes (Classic, Three Kingdoms)
- 2-3 players (local pass-and-play)
- 1 game session at a time
- Support for future modes (Army Chess, custom variants)

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with Dark Chess App Constitution principles:

‚úÖ **Framework**: React Native with Expo Managed Workflow and TypeScript usage  
‚úÖ **Architecture**: Clean Architecture separation (Game Core Logic vs UI Components) - **Enhanced with RuleSet pattern**  
‚úÖ **Testing**: Game Core Logic has 100% unit test coverage plan with Jest - **Applies to both ClassicRules and ThreeKingdomsRules**  
‚úÖ **UI/UX**: Minimalist traditional Chinese aesthetic - **Extended to support 3 team colors (GREEN/RED/BLACK)**  
‚úÖ **Language**: English code/comments and Traditional Chinese UI text  
‚úÖ **State Management**: Zustand usage for game board state - **Extended with mode selection**

**No violations detected.** All technical decisions comply with constitution requirements. The RuleSet abstraction enhances Clean Architecture separation, and the multi-mode support maintains the same strict testing standards.

---

## Project Structure

### Documentation (this feature)

```text
specs/002-three-kingdoms-dark-chess/
‚îú‚îÄ‚îÄ spec.md              # Feature specification (input to /speckit.plan)
‚îú‚îÄ‚îÄ plan.md              # This file (/speckit.plan command output)
‚îú‚îÄ‚îÄ research.md          # Phase 0 output (/speckit.plan command) ‚úÖ
‚îú‚îÄ‚îÄ data-model.md        # Phase 1 output (/speckit.plan command) ‚úÖ
‚îú‚îÄ‚îÄ quickstart.md        # Phase 1 output (/speckit.plan command) ‚úÖ
‚îú‚îÄ‚îÄ contracts/           # Phase 1 output (/speckit.plan command) ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ RuleSet.md
‚îÇ   ‚îú‚îÄ‚îÄ BoardGenerator.md
‚îÇ   ‚îî‚îÄ‚îÄ GameStore.md
‚îî‚îÄ‚îÄ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
‚îú‚îÄ‚îÄ core/                    # Pure TypeScript game logic (NO React dependencies)
‚îÇ   ‚îú‚îÄ‚îÄ types.ts             # ‚úÖ EXISTING - MODIFY: Add GameMode, Faction, extend Match/Piece
‚îÇ   ‚îú‚îÄ‚îÄ RuleSet.ts           # ‚≠ê NEW: RuleSet interface definition
‚îÇ   ‚îú‚îÄ‚îÄ GameModes.ts         # ‚≠ê NEW: GAME_MODES registry (Classic, Three Kingdoms)
‚îÇ   ‚îú‚îÄ‚îÄ rules/               # ‚≠ê NEW: Rule implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClassicRules.ts  # ‚≠ê NEW: Extract from GameEngine.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ThreeKingdomsRules.ts  # ‚≠ê NEW: 3-player logic
‚îÇ   ‚îú‚îÄ‚îÄ GameEngine.ts        # ‚úÖ EXISTING - MODIFY: Delegate to RuleSet, keep utility functions
‚îÇ   ‚îú‚îÄ‚îÄ BoardGenerator.ts    # ‚úÖ EXISTING - MODIFY: Accept GameMode parameter
‚îÇ   ‚îú‚îÄ‚îÄ boardUtils.ts        # ‚úÖ EXISTING - MAY NEED UPDATES for 9x5 grid
‚îÇ   ‚îî‚îÄ‚îÄ rules.ts             # ‚úÖ EXISTING - MAY NEED UPDATES for Three Kingdoms
‚îú‚îÄ‚îÄ components/              # React Native UI components
‚îÇ   ‚îú‚îÄ‚îÄ ModeSelector.tsx     # ‚≠ê NEW: Mode selection UI
‚îÇ   ‚îú‚îÄ‚îÄ BoardView.tsx        # ‚úÖ EXISTING - MODIFY: Conditional renderer
‚îÇ   ‚îú‚îÄ‚îÄ ClassicBoardRenderer.tsx  # ‚≠ê NEW: 8x4 cell-based renderer
‚îÇ   ‚îú‚îÄ‚îÄ IntersectionBoardRenderer.tsx  # ‚≠ê NEW: 9x5 intersection-based renderer
‚îÇ   ‚îú‚îÄ‚îÄ GridCell.tsx         # ‚úÖ EXISTING - MAY NEED UPDATES for intersection styling
‚îÇ   ‚îú‚îÄ‚îÄ PieceComponent.tsx   # ‚úÖ EXISTING - MODIFY: Accept factionColor (green/red/black)
‚îÇ   ‚îî‚îÄ‚îÄ GameInfo.tsx         # ‚úÖ EXISTING - MODIFY: 3-player indicators, draw counter
‚îî‚îÄ‚îÄ store/                   # Zustand state management
    ‚îî‚îÄ‚îÄ gameStore.ts         # ‚úÖ EXISTING - MODIFY: Add currentMode, setMode, loadPersistedMode

tests/
‚îú‚îÄ‚îÄ unit/                    # Jest unit tests (core logic)
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules/           # ‚≠ê NEW: Rule implementation tests
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClassicRules.test.ts  # ‚≠ê NEW: 100% coverage
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ThreeKingdomsRules.test.ts  # ‚≠ê NEW: 100% coverage
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GameEngine.test.ts  # ‚úÖ EXISTING - UPDATE for RuleSet delegation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BoardGenerator.test.ts  # ‚úÖ EXISTING - UPDATE for multi-mode
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rules.test.ts    # ‚úÖ EXISTING - MAY NEED UPDATES
‚îî‚îÄ‚îÄ integration/            # UI integration tests
    ‚îî‚îÄ‚îÄ components/
        ‚îú‚îÄ‚îÄ ModeSelector.test.tsx  # ‚≠ê NEW
        ‚îú‚îÄ‚îÄ ClassicBoardView.test.tsx  # ‚≠ê NEW
        ‚îî‚îÄ‚îÄ IntersectionBoardView.test.tsx  # ‚≠ê NEW
```

**Structure Decision**: 
- **Strategy Pattern**: New `src/core/rules/` directory for pluggable rule implementations
- **Mode Registry**: New `src/core/GameModes.ts` for centralized mode configuration
- **UI Separation**: Separate board renderers for Classic (cells) vs Three Kingdoms (intersections)
- **Backward Compatibility**: Existing Classic components remain functional, extended for multi-mode

---

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. All technical decisions comply with constitution requirements.

---

## Phase 0: Research Complete ‚úÖ

**Date**: 2026-01-22

All technical clarifications resolved. Research document generated at `specs/002-three-kingdoms-dark-chess/research.md`.

**Key Decisions**:

| Decision Area | Approach Selected | Rationale |
|---------------|-------------------|-----------|
| **Rule System** | Strategy Pattern (RuleSet interface) | Flexibility, testability, Open/Closed Principle |
| **Board Representation** | Dynamic-size Board array (32 or 45) | Simplicity, unified type system |
| **Faction System** | Replace `color` with `factionId` + Faction entity | Supports 2-N players, decouples logic from UI |
| **Turn Rotation** | `activeFactions` array with elimination removal | Clear logic, easy to test, skips eliminated players |
| **Draw Counter** | `movesWithoutCapture: number \| null` field | Simple, mode-aware (null for Classic, 60 for TK) |
| **UI Rendering** | Separate ClassicBoardRenderer + IntersectionBoardRenderer | Clarity, avoids complex conditionals |
| **State Management** | Extend Zustand store with `currentMode` | Backward compatible, no breaking changes |
| **Testing** | Separate test suites per RuleSet | 100% coverage per mode, no regressions |
| **Persistence** | AsyncStorage for mode selection | Lightweight, built-in, meets FR-003 |
| **Mode Registry** | Centralized `GAME_MODES` object | Single source of truth, extensible for future modes |

**Research Highlights**:
- **RuleSet Strategy Pattern** enables pluggable rule systems without modifying existing code
- **9x5 intersection grid** requires different adjacency logic from Classic's 8x4 cell grid
- **No rank hierarchy** in Three Kingdoms simplifies capture validation (any piece captures any piece)
- **Draw counter** management requires careful handling in move/capture actions (decrement vs reset)
- **Elimination tracking** uses `activeFactions` array to skip eliminated players in turn rotation

---

## Phase 1: Design Complete ‚úÖ

**Date**: 2026-01-22

**Generated Artifacts**:
- ‚úÖ `research.md` - Technical research and decision log
- ‚úÖ `data-model.md` - Complete entity definitions, relationships, data flow
- ‚úÖ `contracts/RuleSet.md` - RuleSet interface contract with ClassicRules and ThreeKingdomsRules specs
- ‚úÖ `contracts/BoardGenerator.md` - Multi-mode board generation contract
- ‚úÖ `contracts/GameStore.md` - Extended Zustand store contract with mode management
- ‚úÖ `quickstart.md` - Implementation guide and testing strategy

**Agent Context Update**: ‚è∏Ô∏è Pending - will update Cursor IDE context file after commit

**Constitution Check Re-evaluation**: ‚úÖ All principles still compliant after design phase

---

## Phase 2: Implementation Roadmap

**Status**: ‚è∏Ô∏è Ready to proceed - Use `/speckit.tasks` to generate detailed task breakdown

### High-Level Implementation Order

```text
Phase 1: Core Type Refactoring (Day 1, 4 hours)
  ‚îî‚îÄ> Add GameMode, Faction types
  ‚îî‚îÄ> Replace Piece.color with Piece.factionId
  ‚îî‚îÄ> Extend Match type

Phase 2: RuleSet & ClassicRules (Day 1-2, 6 hours)
  ‚îî‚îÄ> Define RuleSet interface
  ‚îî‚îÄ> Extract Classic logic from GameEngine
  ‚îî‚îÄ> Unit tests (100% coverage)

Phase 3: ThreeKingdomsRules (Day 2-3, 8 hours)
  ‚îî‚îÄ> Implement 9x5 adjacency
  ‚îî‚îÄ> Implement no rank hierarchy
  ‚îî‚îÄ> Implement draw counter logic
  ‚îî‚îÄ> Unit tests (100% coverage)

Phase 4: BoardGenerator Multi-Mode (Day 3, 4 hours)
  ‚îî‚îÄ> Refactor createInitialMatch(mode)
  ‚îî‚îÄ> Support 45-element board with 13 nulls
  ‚îî‚îÄ> Implement 12+10+10 piece distribution

Phase 5: State Management (Day 3-4, 5 hours)
  ‚îî‚îÄ> Add currentMode, setMode, loadPersistedMode
  ‚îî‚îÄ> Update newMatch to use currentMode
  ‚îî‚îÄ> Handle draw counter in actions
  ‚îî‚îÄ> AsyncStorage persistence

Phase 6: UI Components (Day 4-5, 8 hours)
  ‚îî‚îÄ> Create ModeSelector
  ‚îî‚îÄ> Create ClassicBoardRenderer
  ‚îî‚îÄ> Create IntersectionBoardRenderer
  ‚îî‚îÄ> Update PieceComponent for 3 colors
  ‚îî‚îÄ> Update GameInfo for 3 players

Phase 7: Integration & E2E Testing (Day 5-6, 8 hours)
  ‚îî‚îÄ> Classic mode regression tests
  ‚îî‚îÄ> Three Kingdoms E2E tests
  ‚îî‚îÄ> Mode switching tests
  ‚îî‚îÄ> Performance tests
```

**Estimated Total Effort**: 4-6 days (43 hours) for TDD implementation + testing

---

## Key Technical Challenges

### Challenge 1: Adjacency Logic for Two Board Topologies

**Problem**: Classic uses 8x4 cell grid, Three Kingdoms uses 9x5 intersection grid. Adjacency calculations differ.

**Solution**:
```typescript
// ClassicRules.getAdjacentIndices (8x4)
const row = Math.floor(index / 4);
const col = index % 4;
// Adjacent: Up (index-4), Down (index+4), Left (index-1), Right (index+1)

// ThreeKingdomsRules.getAdjacentIndices (9x5)
const row = Math.floor(index / 5);
const col = index % 5;
// Adjacent: Up (index-5), Down (index+5), Left (index-1), Right (index+1)
```

**Testing**: Unit tests for each RuleSet implementation must verify correct adjacency for edge cases (corners, edges, middle).

---

### Challenge 2: Faction-Based Turn Rotation with Elimination

**Problem**: 3-player rotation must skip eliminated factions dynamically.

**Solution**:
```typescript
// activeFactions starts as: ['team-a', 'team-b', 'team-c']
// currentFactionIndex cycles through activeFactions array

// When Team B is eliminated:
// activeFactions becomes: ['team-a', 'team-c']
// currentFactionIndex = (currentFactionIndex + 1) % activeFactions.length
// Rotation: Team A ‚Üí Team C ‚Üí Team A (Team B skipped)
```

**Testing**: Integration tests must verify turn rotation correctly skips eliminated factions.

---

### Challenge 3: Draw Counter Management

**Problem**: Draw counter must decrement on non-capture actions, reset on capture, and trigger game end at 0.

**Solution**:
```typescript
// In executeMove (non-capture)
if (newMatch.movesWithoutCapture !== null) {
  newMatch.movesWithoutCapture -= 1;
  if (newMatch.movesWithoutCapture === 0) {
    newMatch.status = 'ended';
    newMatch.winner = null; // Draw
  }
}

// In executeCapture
if (newMatch.movesWithoutCapture !== null) {
  newMatch.movesWithoutCapture = 60; // Reset
}
```

**Testing**: Unit tests must verify counter decrement, reset, and draw detection across multiple turns.

---

### Challenge 4: UI Rendering for Cells vs Intersections

**Problem**: Classic pieces occupy grid cells, Three Kingdoms pieces occupy intersection points. Visual rendering differs.

**Solution**:
- **ClassicBoardRenderer**: Render 8x4 grid of rectangular cells, pieces fill cells
- **IntersectionBoardRenderer**: Render 9x5 grid lines first, then place circular pieces at intersection points (13 empty spots show as small dots)

**Testing**: Snapshot tests and integration tests must verify correct rendering for both modes.

---

## Migration Strategy (Classic ‚Üí Multi-Mode)

### Backward Compatibility Requirements

‚úÖ **Classic mode behavior MUST NOT change** (no regressions)  
‚úÖ **Existing tests MUST continue to pass** without modifications  
‚úÖ **Store API MUST remain compatible** (no breaking changes to actions)

### Data Migration

**Piece.color ‚Üí Piece.factionId**:
```typescript
// Migration helper for existing Classic matches
function migratePiece(oldPiece: OldPiece): Piece {
  return {
    ...oldPiece,
    factionId: oldPiece.color, // "red" or "black"
  };
}
```

**Match.currentTurn ‚Üí Match.currentFactionIndex**:
```typescript
// Migration helper
function migrateMatch(oldMatch: OldMatch): Match {
  const factionIndex = oldMatch.currentTurn === 'red' ? 0 : 1;
  return {
    ...oldMatch,
    mode: GAME_MODES.classic,
    factions: [RED_FACTION, BLACK_FACTION],
    activeFactions: ['red', 'black'],
    currentFactionIndex: factionIndex,
    capturedByFaction: {
      red: oldMatch.redCaptured.map(p => ({ ...p, factionId: 'black' })),
      black: oldMatch.blackCaptured.map(p => ({ ...p, factionId: 'red' })),
    },
    movesWithoutCapture: null,
  };
}
```

---

## Testing Strategy

### Unit Tests (100% Coverage Required)

**Core Logic**:
- ‚úÖ `src/core/rules/ClassicRules.test.ts` - 100% coverage (extracted logic)
- ‚≠ê `src/core/rules/ThreeKingdomsRules.test.ts` - 100% coverage (new logic)
- ‚úÖ `src/core/BoardGenerator.test.ts` - Both modes (32-element and 45-element boards)
- ‚úÖ `src/core/GameEngine.test.ts` - RuleSet delegation (no regressions)

**State Management**:
- ‚úÖ `src/store/gameStore.test.ts` - Mode selection, persistence, both modes

### Integration Tests

**UI Components**:
- ‚≠ê `tests/integration/components/ModeSelector.test.tsx` - Mode selection UI
- ‚≠ê `tests/integration/components/ClassicBoardView.test.tsx` - 8x4 cell rendering
- ‚≠ê `tests/integration/components/IntersectionBoardView.test.tsx` - 9x5 intersection rendering

**E2E Flows**:
- ‚úÖ `tests/e2e/ClassicGameFlow.test.tsx` - No regressions from 001
- ‚≠ê `tests/e2e/ThreeKingdomsGameFlow.test.tsx` - Full 3-player game (flip, move, capture, elimination, draw)

### Performance Tests

- ‚úÖ Match initialization < 2 seconds (both modes)
- ‚úÖ Move validation < 10ms (both modes)
- ‚úÖ Board rendering 60 FPS (both modes)
- ‚≠ê Three Kingdoms with 3 players: no lag in UI responsiveness

---

## Success Criteria

**From Specification (SC-001 to SC-009)**:

‚úÖ **SC-001**: Users can successfully complete a 3-player Three Kingdoms match from setup to victory or draw  
‚úÖ **SC-002**: Mode selector UI allows switching between Classic and Three Kingdoms in < 3 taps  
‚úÖ **SC-003**: 100% of Three Kingdoms rules are correctly enforced (verified by unit tests)  
‚úÖ **SC-004**: 3-player turn rotation with elimination skipping works correctly in 100% of test cases  
‚úÖ **SC-005**: Elimination victory is correctly detected in 100% of test scenarios  
‚úÖ **SC-006**: Draw condition (60 moves without capture) is correctly enforced in 100% of test scenarios  
‚úÖ **SC-007**: UI clearly distinguishes 3 teams with GREEN/RED/BLACK colors (validated by user testing)  
‚úÖ **SC-008**: Architecture supports adding future variants (e.g., Army Chess) without major refactoring  
‚úÖ **SC-009**: No performance degradation with 3 players and 45-position board (frame rate stays > 50 FPS)

---

## Risks & Mitigation

### Risk 1: Performance Degradation with 45-Position Board

**Risk**: Larger board (45 vs 32) and 3 players may slow down rendering/validation.

**Mitigation**:
- Profile move validation and rendering performance early
- Optimize `getLegalMoves` if needed (currently scans entire board)
- Use React.memo for PieceComponent and GridCell
- Target: Maintain 60 FPS, < 10ms validation time

---

### Risk 2: Regression in Classic Mode

**Risk**: Refactoring GameEngine may introduce bugs in Classic gameplay.

**Mitigation**:
- Run all existing 001 tests after each refactoring step
- Use TDD: write tests first, refactor second
- Compare behavior: old GameEngine vs new ClassicRules (unit tests)
- Manual QA: Play full Classic game before/after refactoring

---

### Risk 3: Complexity in Turn Rotation with Elimination

**Risk**: Dynamic `activeFactions` array may cause off-by-one errors or infinite loops.

**Mitigation**:
- Write comprehensive unit tests for turn rotation edge cases:
  - All 3 factions active
  - 2 factions active (1 eliminated)
  - 1 faction active (game ends)
- Test elimination mid-turn (ensure current turn completes before faction removed)

---

## Next Steps

1. ‚úÖ Phase 0: Research complete (this document)
2. ‚úÖ Phase 1: Design complete (data-model, contracts, quickstart)
3. üîú **Run `/speckit.tasks`** to generate detailed task breakdown
4. üîú Begin TDD implementation following quickstart.md phases
5. üîú Commit after each phase with Conventional Commits format
6. üîú Manual QA testing on physical devices (iOS + Android)
7. üîú Merge to main after all tests pass (no regressions)
8. üîú Plan next feature (004-ai-opponent or 010-online-multiplayer)

---

## References

### Specification Documents
- **Feature Spec**: `specs/002-three-kingdoms-dark-chess/spec.md`
- **Data Model**: `specs/002-three-kingdoms-dark-chess/data-model.md`
- **Research**: `specs/002-three-kingdoms-dark-chess/research.md`
- **Quickstart**: `specs/002-three-kingdoms-dark-chess/quickstart.md`

### Contracts
- **RuleSet Interface**: `specs/002-three-kingdoms-dark-chess/contracts/RuleSet.md`
- **BoardGenerator**: `specs/002-three-kingdoms-dark-chess/contracts/BoardGenerator.md`
- **GameStore**: `specs/002-three-kingdoms-dark-chess/contracts/GameStore.md`

### Related Features
- **001-banqi-game-rules**: Classic Dark Chess foundation (dependency)
- **ROADMAP.md**: Strategic pivot to Three Kingdoms as next core feature

---

**Plan Version**: 1.0.0  
**Status**: ‚úÖ Complete - Ready for `/speckit.tasks` command  
**Last Updated**: 2026-01-22  
**Author**: AI Assistant (via `/speckit.plan` workflow)
